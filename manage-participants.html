<!DOCTYPE html>
<html>
<head>
  <title>Manage Participants</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .participant-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .filter-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: center;
    }
    .filter-controls select, .filter-controls input {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      min-width: 150px;
    }
    .payment-status.paid {
      color: green;
      font-weight: bold;
    }
    .payment-status.pending {
      color: orange;
      font-weight: bold;
    }
    .payment-status.failed {
      color: red;
      font-weight: bold;
    }
    .action-btn {
      padding: 5px 8px;
      margin: 0 3px;
      cursor: pointer;
    }
    .no-participants {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>FSKTM Event Management</h2>
    <div class="user-info">
      <div class="user-avatar"></div>
      <span class="user-name"></span>
      <button onclick="handleLogout()" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </div>
  
  <div class="container">
    <div class="sidebar">
      <ul class="sidebar-menu">
        <li><a href="organizer-dashboard.html"><i class="fas fa-arrow-left"></i> Back</a></li>
        <li><a href="organizer-dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
        <li><a href="#"><i class="fas fa-calendar-alt"></i> My Events</a></li>
      </ul>
    </div>
    
    <div class="main">
      <div class="section-title">
        <h3>Manage Participants</h3>
        <h4 id="eventTitle">Loading...</h4>
      </div>
      
      <div class="filter-controls">
        <select id="paymentFilter">
          <option value="all">All Payments</option>
          <option value="paid">Paid</option>
          <option value="pending">Pending</option>
          <option value="failed">Failed</option>
        </select>
        <input type="text" id="searchInput" placeholder="Search participants...">
        <button class="btn btn-outline" onclick="applyFilters()">
          <i class="fas fa-filter"></i> Apply
        </button>
        <button class="btn btn-outline" onclick="resetFilters()">
          <i class="fas fa-sync-alt"></i> Reset
        </button>
      </div>
      
      <div class="card">
        <table class="table">
          <thead>
            <tr>
              <th>No.</th>
              <th>Name</th>
              <th>Student ID</th>
              <th>Department</th>
              <th>Registration Date</th>
              <th>Payment Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="participantsTable">
            <!-- Participants will be loaded here -->
          </tbody>
        </table>
        
        <div class="participant-actions">
          <button class="btn btn-primary" onclick="exportToExcel()">
            <i class="fas fa-file-excel"></i> Export to Excel
          </button>
          <button class="btn btn-success" onclick="emailAllParticipants()">
            <i class="fas fa-envelope"></i> Email All
          </button>
          <button class="btn btn-warning" onclick="printParticipantList()">
            <i class="fas fa-print"></i> Print List
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/mock-data.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // Global variables
    let currentEvent = null;
    let allParticipants = [];
    let filteredParticipants = [];
    
    // DOM elements
    const eventTitleEl = document.getElementById('eventTitle');
    const participantsTableEl = document.getElementById('participantsTable');
    const paymentFilterEl = document.getElementById('paymentFilter');
    const searchInputEl = document.getElementById('searchInput');

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
      const user = getCurrentUser();
      if (!user || user.role !== 'organizer') {
        window.location.href = 'index.html';
        return;
      }

      // Display user name if available
      if (user.name) {
        document.querySelector('.user-name').textContent = user.name;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const eventId = urlParams.get('id');
      
      if (!eventId) {
        alert('Event ID not specified');
        window.location.href = 'organizer-dashboard.html';
        return;
      }

      loadEventData(eventId);
    });

    // Load event and participant data
    function loadEventData(eventId) {
      currentEvent = getEventById(eventId);
      
      if (!currentEvent) {
        alert('Event not found');
        window.location.href = 'organizer-dashboard.html';
        return;
      }

      eventTitleEl.textContent = currentEvent.title;
      allParticipants = getParticipants(eventId);
      filteredParticipants = [...allParticipants];
      
      renderParticipantsTable();
    }

    // Render participants table
    function renderParticipantsTable() {
      participantsTableEl.innerHTML = '';

      if (filteredParticipants.length === 0) {
        participantsTableEl.innerHTML = `
          <tr>
            <td colspan="7" class="no-participants">
              No participants found matching your criteria
            </td>
          </tr>
        `;
        return;
      }

      filteredParticipants.forEach((participant, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${participant.name}</td>
          <td>${participant.studentId}</td>
          <td>${participant.department}</td>
          <td>${formatDate(participant.registrationDate)}</td>
          <td class="payment-status ${participant.paymentStatus}">
            ${participant.paymentStatus.toUpperCase()}
          </td>
          <td>
            <button class="btn btn-outline action-btn" onclick="sendNotificationToParticipant('${participant.id}')">
              <i class="fas fa-envelope"></i>
            </button>
            <button class="btn btn-outline action-btn" onclick="verifyPayment('${participant.id}')">
              <i class="fas fa-check"></i>
            </button>
          </td>
        `;
        participantsTableEl.appendChild(row);
      });
    }

    // Filter functions
    function applyFilters() {
      const paymentStatus = paymentFilterEl.value;
      const searchTerm = searchInputEl.value.toLowerCase();
      
      filteredParticipants = allParticipants.filter(participant => {
        // Filter by payment status
        if (paymentStatus !== 'all' && participant.paymentStatus !== paymentStatus) {
          return false;
        }
        
        // Filter by search term
        if (searchTerm) {
          return (
            participant.name.toLowerCase().includes(searchTerm) ||
            participant.studentId.toLowerCase().includes(searchTerm) ||
            participant.department.toLowerCase().includes(searchTerm)
          );
        }
        
        return true;
      });
      
      renderParticipantsTable();
    }

    function resetFilters() {
      paymentFilterEl.value = 'all';
      searchInputEl.value = '';
      filteredParticipants = [...allParticipants];
      renderParticipantsTable();
    }

    // Participant actions
    function verifyPayment(participantId) {
      if (!confirm('Are you sure you want to verify this payment?')) {
        return;
      }
      
      const participant = allParticipants.find(p => p.id === participantId);
      const user = getCurrentUser();

      if (!participant) {
        alert('Participant not found');
        return;
      }

      if (participant.paymentStatus === 'paid') {
        alert('Payment already verified.');
        return;
      }

      // Update payment status
      participant.paymentStatus = 'paid';
      
      // In a real app, you would save this to your database here
      // updateParticipantPaymentStatus(participantId, 'paid');
      
      // Send notification
      sendNotification(
        user.id, 
        participantId, 
        `Your payment for event "${currentEvent.title}" has been verified.`
      );
      
      alert('Payment verified and student notified.');
      applyFilters(); // Refresh the table with current filters
    }

    function sendNotificationToParticipant(participantId) {
      const message = prompt("Enter message to send to participant:");
      const user = getCurrentUser();
      
      if (message) {
        sendNotification(
          user.id, 
          participantId, 
          `Message regarding "${currentEvent.title}": ${message}`
        );
        alert("Notification sent.");
      }
    }

    // Bulk actions
    function exportToExcel() {
      alert('Export to Excel functionality would be implemented here');
      // In a real implementation, you would:
      // 1. Prepare the data
      // 2. Use a library like SheetJS to create the Excel file
      // 3. Trigger download
    }

    function emailAllParticipants() {
      if (filteredParticipants.length === 0) {
        alert('No participants to email');
        return;
      }
      
      const subject = prompt("Email subject:", `Regarding ${currentEvent.title}`);
      if (!subject) return;
      
      const body = prompt("Email body:", `Dear participant,\n\nThis is regarding ${currentEvent.title}...`);
      if (!body) return;
      
      alert(`Email would be sent to ${filteredParticipants.length} participants with:\n\nSubject: ${subject}\n\nBody: ${body}`);
      // In a real implementation, you would connect to your email service
    }

    function printParticipantList() {
      window.print();
    }

    // Helper functions
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function handleLogout() {
      logout();
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>